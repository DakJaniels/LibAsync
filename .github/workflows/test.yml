name: Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    name: Run LibAsync Tests
    runs-on: windows-latest
    
    steps:
      - name: Checkout LibAsync
        uses: actions/checkout@v4
      
      - name: Setup ESOUI Source
        run: |
          git clone --depth 1 --branch live https://github.com/esoui/esoui.git esoui
      
      - name: Setup Taneth
        run: |
          # Download pre-built Taneth from ESOUI
          $tanethDir = "taneth"
          New-Item -ItemType Directory -Path $tanethDir -Force | Out-Null
          
          Write-Host "Downloading Taneth 1.1.0 from ESOUI..."
          $tanethUrl = "https://www.esoui.com/downloads/dl3584/Taneth_1_1_0.zip"
          $zipPath = "$tanethDir\Taneth_1_1_0.zip"
          
          try {
            Invoke-WebRequest -Uri $tanethUrl -OutFile $zipPath -ErrorAction Stop
            Expand-Archive -Path $zipPath -DestinationPath $tanethDir -Force
            Write-Host "Taneth downloaded and extracted successfully"
            
            # Check if Taneth files are in a subdirectory
            $tanethFiles = Get-ChildItem -Path $tanethDir -Filter "*.lua" -Recurse -ErrorAction SilentlyContinue
            if ($tanethFiles) {
              Write-Host "Found $($tanethFiles.Count) Taneth Lua files"
            }
          } catch {
            Write-Host "Failed to download Taneth, falling back to cloning from GitHub..."
            git clone --depth 1 https://github.com/sirinsidiator/ESO-Taneth.git taneth-git
            if (Test-Path "taneth-git") {
              Move-Item -Path "taneth-git\*" -Destination $tanethDir -Force -ErrorAction SilentlyContinue
            }
          }
      
      - name: Setup ESOLua
        run: |
          # Download pre-built ESOLua from ESOUI
          $esoluaDir = "esolua"
          New-Item -ItemType Directory -Path $esoluaDir -Force | Out-Null
          
          Write-Host "Downloading ESOLua 1.1.0 from ESOUI..."
          $esoluaUrl = "https://www.esoui.com/downloads/dl3583/ESOLua-1.1.0.zip"
          $zipPath = "$esoluaDir\ESOLua-1.1.0.zip"
          
          try {
            Invoke-WebRequest -Uri $esoluaUrl -OutFile $zipPath -ErrorAction Stop
            Expand-Archive -Path $zipPath -DestinationPath $esoluaDir -Force
            Write-Host "ESOLua downloaded and extracted successfully"
            
            # Find esolua.exe (may be in a subdirectory)
            $exeFiles = Get-ChildItem -Path $esoluaDir -Filter "esolua.exe" -Recurse -ErrorAction SilentlyContinue
            if ($exeFiles) {
              Write-Host "Found ESOLua executable: $($exeFiles[0].FullName)"
              # If extracted to a subdirectory, move files to root for easier access
              $exeDir = $exeFiles[0].DirectoryName
              if ($exeDir -ne (Resolve-Path $esoluaDir).Path) {
                Write-Host "Moving ESOLua files to root directory..."
                Get-ChildItem -Path $exeDir -File | ForEach-Object {
                  Move-Item -Path $_.FullName -Destination $esoluaDir -Force
                }
              }
            } else {
              Write-Host "Warning: esolua.exe not found after extraction"
            }
          } catch {
            Write-Host "Failed to download ESOLua: $_"
            Write-Host "Will attempt to use system Lua 5.1 as fallback"
          }
      
      - name: Create Test Environment
        run: |
          # Create test environment structure
          $testDir = "test_env"
          $addonsDir = "$testDir\AddOns"
          
          New-Item -ItemType Directory -Path "$addonsDir\LibAsync" -Force | Out-Null
          New-Item -ItemType Directory -Path "$addonsDir\Taneth" -Force | Out-Null
          
          # Copy LibAsync files
          Copy-Item -Path "LibAsync.lua" -Destination "$addonsDir\LibAsync\" -Force
          Copy-Item -Path "LibAsync.addon" -Destination "$addonsDir\LibAsync\" -Force
          
          # Copy test files
          if (Test-Path "tests") {
              Copy-Item -Path "tests" -Destination "$addonsDir\LibAsync\" -Recurse -Force
          }
          
          # Fix ESOUI directory structure for ESOLua
          # Git clone creates esoui/esoui/ (two levels), but we flattened it incorrectly
          # ESOLua expects esoui/ with both ingame/ and esoui/ subdirectories
          # Current state: esoui/ has ingame/ but missing esoui/esoui/
          # Need to check if we have esoui/esoui/esoui/ (three levels) and fix it
          
          if (Test-Path "esoui\esoui\esoui") {
            Write-Host "Detected three-level nesting (esoui/esoui/esoui/), restructuring..."
            # Move third level contents up to second level
            $thirdLevel = "esoui\esoui\esoui"
            $secondLevel = "esoui\esoui"
            
            # Copy contents from third level to second level
            Get-ChildItem -Path $thirdLevel -Force | ForEach-Object {
              $dest = Join-Path $secondLevel $_.Name
              if (-not (Test-Path $dest)) {
                Copy-Item -Path $_.FullName -Destination $dest -Recurse -Force
              }
            }
            Write-Host "Restructured from esoui/esoui/esoui/ to esoui/esoui/"
          }
          
          # Ensure esoui/esoui/ exists (ESOLua requires it)
          if (-not (Test-Path "esoui\esoui")) {
            Write-Host "Creating missing esoui/esoui/ directory for ESOLua..."
            New-Item -ItemType Directory -Path "esoui\esoui" -Force | Out-Null
            
            # Copy all source directories from esoui/ to esoui/esoui/ (except esoui itself)
            Get-ChildItem -Path "esoui" -Directory | Where-Object { $_.Name -ne "esoui" } | ForEach-Object {
              $dest = Join-Path "esoui\esoui" $_.Name
              Write-Host "  Copying esoui/$($_.Name) to esoui/esoui/$($_.Name)"
              Copy-Item -Path $_.FullName -Destination $dest -Recurse -Force
            }
            Write-Host "Created esoui/esoui/ structure"
          }
          
          # Verify ESOLua can find the structure it needs
          if (Test-Path "esoui\ingame") {
            Write-Host "Verified: esoui/ingame/ found"
          } else {
            Write-Host "Warning: esoui/ingame/ not found"
          }
          
          if (Test-Path "esoui\esoui") {
            Write-Host "Verified: esoui/esoui/ found"
          } else {
            Write-Host "ERROR: esoui/esoui/ not found - ESOLua requires this directory"
          }
          
          # Copy Taneth files (from downloaded zip or cloned repo)
          $tanethSource = $null
          
          # Check for Taneth directory from zip (Taneth/Taneth/...)
          if (Test-Path "taneth\Taneth") {
            $tanethSource = "taneth\Taneth"
          }
          # Check for src directory from git clone
          elseif (Test-Path "taneth\src") {
            $tanethSource = "taneth\src"
          }
          # Check for files directly in taneth root
          elseif (Test-Path "taneth\*.lua") {
            $tanethSource = "taneth"
          }
          
          if ($tanethSource) {
            $tanethSrcPath = Resolve-Path $tanethSource
            $tanethFiles = Get-ChildItem -Path $tanethSource -Filter "*.lua" -Recurse -File -ErrorAction SilentlyContinue
            if ($tanethFiles) {
              foreach ($file in $tanethFiles) {
                $relativePath = $file.FullName.Substring($tanethSrcPath.Path.Length + 1)
                $destPath = Join-Path "$addonsDir\Taneth" $relativePath
                $destDir = Split-Path $destPath -Parent
                if (-not (Test-Path $destDir)) {
                  New-Item -ItemType Directory -Path $destDir -Force | Out-Null
                }
                Copy-Item -Path $file.FullName -Destination $destPath -Force
              }
              Write-Host "Taneth files copied successfully ($($tanethFiles.Count) files)"
            } else {
              Write-Host "Warning: No Lua files found in $tanethSource"
            }
          } else {
            Write-Host "Warning: Taneth files not found in expected locations"
            Get-ChildItem -Path "taneth" -Recurse -Directory | Select-Object -First 5 | ForEach-Object { Write-Host "Found directory: $($_.FullName)" }
          }
      
      - name: Create Test Runner Script
        run: |
          $runnerScript = @'
          -- Test runner for LibAsync using ESOLua
          package.path = package.path .. ";test_env/esoui/?.lua;test_env/esoui/esoui/?.lua;test_env/AddOns/?.lua;test_env/AddOns/?/?.lua"
          
          -- Load basic ESO globals (minimal mock)
          _G.GetFrameTimeSeconds = function() return os.clock() end
          _G.GetGameTimeSeconds = function() return os.clock() end
          _G.GetEventManager = function() 
              local em = {updateIds = {}, eventHandlers = {}}
              function em:RegisterForUpdate(id, interval, func)
                  self.updateIds[id] = {interval = interval, func = func, last = os.clock()}
              end
              function em:UnregisterForUpdate(id)
                  self.updateIds[id] = nil
              end
              function em:RegisterForEvent(id, eventType, callback)
                  self.eventHandlers[id] = {eventType = eventType, callback = callback}
              end
              function em:UnregisterForEvent(id, eventType)
                  self.eventHandlers[id] = nil
              end
              return em
          end
          _G.GetFramerate = function() return 60 end
          _G.HUD_SCENE = {IsShowing = function() return true end}
          _G.HUD_UI_SCENE = {IsShowing = function() return false end}
          _G.EVENT_PLAYER_ACTIVATED = 1  -- Mock event constant
          -- Mock ZO_InitializingCallbackObject for class inheritance
          local ZO_InitializingCallbackObjectBase = {
              New = function(class)
                  -- Create a new instance with class as metatable
                  local instance = {}
                  setmetatable(instance, {__index = class})
                  return instance
              end,
              Subclass = function(base)
                  -- Create a new class that inherits from base
                  local subclass = {}
                  setmetatable(subclass, {__index = base})
                  return subclass
              end
          }
          _G.ZO_InitializingCallbackObject = ZO_InitializingCallbackObjectBase
          _G.ZO_ClearNumericallyIndexedTable = function(t) for i = #t, 1, -1 do t[i] = nil end end
          _G.zo_callLater = function(func, ms) 
              -- Simple delayed call simulation
              local start = os.clock()
              while os.clock() - start < ms / 1000 do end
              func()
          end
          _G.CHAT_ROUTER = {AddSystemMessage = function(msg) print(msg) end}
          _G.SLASH_COMMANDS = {}
          _G.EventManager = GetEventManager()
          _G.em = GetEventManager()
          _G.EVENT_MANAGER = EventManager  -- Taneth uses this global
          
          -- Add other globals that Taneth might need
          _G.GetString = function(id) return tostring(id) end
          _G.SI_APPLY = 1  -- Mock string ID constant
          
          -- Load Taneth in manifest order:
          -- 1. StartUp.lua
          -- 2. Assertions.lua
          -- 3. TestRunner.lua
          -- 4. API.lua
          local tanethBasePath = nil
          if io.open("test_env/AddOns/Taneth/StartUp.lua", "r") then
              tanethBasePath = "test_env/AddOns/Taneth"
          elseif io.open("test_env/AddOns/Taneth/Taneth/StartUp.lua", "r") then
              tanethBasePath = "test_env/AddOns/Taneth/Taneth"
          end
          
          if tanethBasePath then
              local tanethFiles = {
                  "StartUp.lua",
                  "Assertions.lua",
                  "TestRunner.lua",
                  "API.lua"
              }
              
              for _, file in ipairs(tanethFiles) do
                  local path = tanethBasePath .. "/" .. file
                  local f = io.open(path, "r")
                  if f then
                      f:close()
                      dofile(path)
                  else
                      print("Warning: Could not load " .. path)
                  end
              end
              print("Taneth loaded from: " .. tanethBasePath)
          else
              error("Taneth not found in expected locations")
          end
          
          -- Verify Taneth is loaded and callable
          if not Taneth or type(Taneth) ~= "table" then
              error("Taneth failed to load properly")
          end
          print("Taneth verified and ready")
          
          -- Load LibAsync
          dofile("test_env/AddOns/LibAsync/LibAsync.lua")
          
          -- Load and register tests
          dofile("test_env/AddOns/LibAsync/tests/LibAsync_test.lua")
          
          -- Run tests
          print("Running LibAsync tests...")
          local success = Taneth:RunTestSuites({"LibAsync"}, function()
              print("All tests completed successfully!")
              os.exit(0)
          end)
          
          if not success then
              print("Tests completed synchronously")
              os.exit(0)
          end
          '@
          
          $runnerScript | Out-File -FilePath "run_tests.lua" -Encoding utf8
      
      - name: Run Tests with ESOLua
        run: |
          # Find ESOLua executable
          $esoluaExe = $null
          if (Test-Path "esolua") {
              $exeFiles = Get-ChildItem -Path "esolua" -Filter "esolua.exe" -Recurse -ErrorAction SilentlyContinue
              if ($exeFiles) {
                  $esoluaExe = $exeFiles[0].FullName
                  Write-Host "Found ESOLua: $esoluaExe"
              }
          }
          
          if (-not $esoluaExe) {
              Write-Host "ERROR: ESOLua executable not found!"
              Write-Host "Please ensure ESOLua was downloaded successfully in the Setup ESOLua step"
              exit 1
          }
          
          Write-Host "Running tests with ESOLua..."
          
          # Debug: Check ESOUI directory structure ESOLua expects
          if (Test-Path "esoui") {
              Write-Host "ESOUI directory exists at: $(Resolve-Path esoui)"
              Write-Host "Checking ESOUI structure for ESOLua..."
              $expectedDirs = @("ingame", "esoui")
              $structureOk = $true
              foreach ($dir in $expectedDirs) {
                  if (Test-Path "esoui\$dir") {
                      Write-Host "  ✓ Found: esoui\$dir"
                  } else {
                      Write-Host "  ✗ Missing: esoui\$dir"
                      $structureOk = $false
                  }
              }
              
              if (-not $structureOk) {
                  Write-Host "Warning: ESOUI structure may be incomplete. ESOLua may fail to initialize."
                  Write-Host "Listing esoui directory contents:"
                  Get-ChildItem -Path "esoui" -Directory | Select-Object -First 10 | ForEach-Object { Write-Host "    $($_.Name)" }
              }
              
              Write-Host "Running test script with ESOLua (ESOUI initialization may warn but script will continue with mocks)..."
              & $esoluaExe -s esoui run_tests.lua 2>&1
          } else {
              Write-Host "Warning: esoui directory not found, running without ESOUI initialization"
              & $esoluaExe run_tests.lua
          }
          if ($LASTEXITCODE -ne 0) {
              Write-Host "Tests failed with exit code: $LASTEXITCODE"
              exit $LASTEXITCODE
          }
